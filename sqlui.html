<!DOCTYPE html>

<html>
<head>
    <title>SQL Query</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style type="text/css">
/* Full page mode */
html,body {
    height: 100% !important;
}
body, p, div, span, table, input, button, select, textarea, pre, a, ol, h1, h2, h3, h4, h5, h6 {
    border-spacing: 0px 0px;
    padding: 0;
    margin: 0;
    color: #aaa;
}
body {
    font-family: Segoe UI, Verdana, Tahoma;
    font-size: small;
    margin-top: 8px !important;
    margin-left: 8px !important;
    margin-right: 12px !important;
    margin-bottom: 12px !important;
    overflow: hidden;
    background-color: #151515 !important;
}
dt {
    display: inline-block;
    margin: 0;
    font-family: 'Anonymous Pro', Consolas, 'Courier New', 'Lucida Console', monospace;
    background-color: black;
    color: white;
    border-radius: 2px;
    padding: 3px 6px;
}
dd {
    display: inline;
    margin: 0;
}
dl {
    margin: 5px 0 5px 0;
}
.code {
    font-family: 'Anonymous Pro', Consolas, 'Courier New', 'Lucida Console', monospace;
    border-radius: 2px;
    padding: 3px 6px;
}
ul, ol, li {
    border-spacing: 0px 0px;
    margin: 0;
}
ul, ol {
    padding-left: 24px;
}
button {
    padding: 2px 4px 2px 4px;
    border-radius: 3px 3px;
    border-style: double;
    border-color: #1a1a1a;
    background-color: #242424;
    text-shadow: black 0.1em 0.1em 0.2em;
    cursor: pointer;
}
button:disabled {
    border-color: #2a2a2a;
    background-color: #343434;
    color: #aaa;
    text-shadow: #666 -0.1em -0.1em -0.2em;
    cursor: default;
}
table td, table th {
    padding: 0;
    margin: 0;
    text-align: left;
    vertical-align: top;
}
table.padded td, table.padded th {
    padding: 1px 2px 1px 2px;
}
input, select {
    border: 1px solid gray;
    background-color: #101010;
    color: #bbb;
}
input:disabled, select:disabled {
    border: 1px solid gray;
    background-color: #2c2c2c;
    color: #999;
}
input.highlight {
    background-color: #303010 !important;
    outline: 1px solid #992 !important;
}
::-webkit-input-placeholder {
    color: #555;
}
input:-moz-placeholder {
    color: #555;
}
textarea, pre {
    font-family: 'Anonymous Pro', Consolas, 'Courier New', 'Lucida Console', monospace;
}
textarea {
    background-color: #101010;
    color: #bbb;
}
.mid {
    vertical-align: middle;
}
.nowrap {
    white-space: nowrap;
}
input.sidebar {
    width: 180px;
}
input.sidebar-ds {
    width: 208px
}
select.sidebar {
    width: 200px;
}
input.sidebar-half {
    width: 100px;
}
table.tblResults {
    border-spacing: 0px;
}
table.tblResults > tbody > tr > th {
    padding: 1px 2px 1px 2px;
    white-space: nowrap;
    background-color: #0c0c10;
    color: #aaa;
}
table.tblResults > tbody > tr > td {
    padding: 1px 2px 1px 2px;
}
table.tblResults > tbody > tr:nth-child(2n+0) > td {
    background-color: #151515;
}
table.tblResults > tbody > tr:nth-child(2n+1) > td {
    background-color: #1c1c1c;
}
table.tblResults > tbody > tr:nth-child(2n+0) > td.nullv {
    background-color: #1f1010 !important;
}
table.tblResults > tbody > tr:nth-child(2n+1) > td.nullv {
    background-color: #251717 !important;
}
td.nullv {
    color: #bbb;
    text-align: center;
    font-weight: bold;
}
td.rownum {
    font-weight: bold;
    text-align: right;
    background-color: #0c0c10 !important;
    padding-right: 2px;
    padding-left: 2px;
}

/* Query textarea resizer handle */
div.resizer-vertical {
    cursor: ns-resize;
    background-color: #444;
    width: 100%;
    height: 12px;
    position: absolute;
    top: 100px;
}

div.resizer-container {
    position: relative;
}

/* tabs */
div.tab-container > div.tab-panel {
    border: 1px solid gray;
    clear: both;
    padding: 4px 4px;
}

/* Facebox */
#facebox_overlay {
    position: absolute;
    left: 0px;
    top: 0px;
    width: 100%;
    height: 100%;
    background-color: white;
    opacity: 0.15;
    z-index: 99;
}
#facebox {
    position: absolute;
    left: 240px;
    top: 140px;
    z-index: 100;
}
.popup {
    position: relative;
    border: 3px solid transparent;
    border-radius: 5px;
    box-shadow: 0 0 18px rgba(0,0,0,0.4);
}
.shortcuts {
    width: 640px;
    padding: 10px 10px 10px 10px;
    border-radius: 5px;
    background-color: #262626;
}

/* NOTE(jsd): More web FAIL. No way for FF to set custom scrollbar. */
::-webkit-scrollbar {
    width: 12px;
    height: 12px;
}
::-webkit-scrollbar-button {
    width: 0;
    height: 0;
    display: none;
}
::-webkit-scrollbar-thumb {
    background-color: rgba(255, 255, 255, 0.4);
    -webkit-box-shadow: inset 1px 1px 0 rgba(255, 255, 255, 0.10),inset 0 -1px 0 rgba(255, 255, 255, 0.07);
}
::-webkit-scrollbar-corner {
    background-color: transparent;
}
    </style>
</head>
<body>
    <div style="width: 100%" class="padded">
        <table id="toppanel" style="width: 100%" border="0"><tbody>
            <tr>
                <td class="nowrap mid">User:</td>
                <td class="nowrap"><div>
                    <input id="auid" class="sidebar-half" type="text" value="" title="Username" placeholder="username" />&nbsp;
                    <input id="apwd" class="sidebar-half" type="password" value="" title="Password" placeholder="password" />
                </div></td>
                <td style="float: right">
                    <button type="button" id="btnHelp">Help</button>
                </td>
            </tr>
        </tbody></table>

        <div id="query-tabs" class="tab-container">
            <div class="tab-panel">
                <table id="commandBar" border="0" style="width: 100%"><tbody>
                    <tr>
                        <td class="nowrap mid"><label for="intsec"><input id="intsec" type="checkbox" checked="checked"/>&nbsp;Integrated Security</label></td>
                        <td class="nowrap mid"><input id="uid" class="sidebar" type="text" value="" disabled="disabled" placeholder="user ID" title="Connection String User ID" /></td>
                        <td class="nowrap mid"><input id="pwd" class="sidebar" type="password" value="" disabled="disabled" placeholder="password" title="Connection String Password" /></td>
                        <td class="nowrap mid"><label for="timeout">Timeout:&nbsp;<input id="timeout" class="sidebar" type="number" value="30" min="0" max="900" step="10" style="width: 64px; text-align: right" title="Number of seconds to wait for command execution" /></label></td>
                        <td class="nowrap mid"><label for="rowcount">Row Count:&nbsp;<input id="rowcount" class="sidebar" type="number" value="100" min="0" max="50000" step="10" style="width: 64px; text-align: right" title="Limit number of rows (0 for unlimited)" /></label></td>
                        <td class="nowrap mid" style="float: right"><button type="button" id="btnLink">Update Link</button></td>
                    </tr>
                    <tr>
                        <td class="nowrap mid"><input id="ds" class="sidebar-ds" type="text" list="dataSources" placeholder="(server)\(instance)" title="Connection String Data Source" /><datalist id="dataSources"></datalist>&nbsp;<button id="btnConnect" type="button" title="Click to fetch catalog list">&hellip;</button></td>
                        <td class="nowrap mid"><input id="ic" class="sidebar" type="text" list="catalogs" placeholder="catalog" title="Connection String Initial Catalog (click '&hellip;' button above to refresh list)"/>
                            <datalist id="catalogs"></datalist>
                        </td>
                        <td class="nowrap mid" style="height: 28px">
                            <button type="button" id="btnExecute">Execute</button>&nbsp;
                            <button type="button" id="btnCancel" disabled="disabled">Cancel</button>&nbsp;
                        </td>
                        <td class="nowrap mid">
                            <label for="chkHeadRepeat"><input type="checkbox" id="chkHeadRepeat" checked="checked" />&nbsp;Header repeats every&nbsp;</label>
                            <label for="numHeadRepeat"><input type="number" id="numHeadRepeat" value="20" style="width: 56px; text-align: right" min="10" max="2000" step="10" />&nbsp;rows</label>
                        </td>
                        <td class="nowrap mid">
                            <label for="chkRowNumbers"><input type="checkbox" id="chkRowNumbers" checked="checked" />&nbsp;Show row rumbers</label>
                        </td>
                        <td class="nowrap mid" style="float: right"><a id="selflink" href="#" style="display: none" title="Open query in new window" target="_blank">link</a></td>
                    </tr>
                </tbody></table>
                <div id="trQuery" class="resizer-container">
                    <textarea name="query" id="query" style="width: 100%; height: 97px; word-wrap: normal; overflow: auto; resize: none" autofocus="autofocus" spellcheck="false">SELECT 1</textarea>
                    <div id="rszQuery" class="resizer-vertical"></div>
                    <div style="height: 12px"></div>
                </div>
                <div id="trResults" style="min-height: 24px">
                    <div style="clear: both; overflow-y: auto">
                        <div id="divErrors" style="display: none; overflow-x: auto">
                            <h3>Errors</h3>
                            <ul id="ulErrors"></ul>
                        </div>
                        <div style="float: right">
                            <span id="txtMsec"></span>
                        </div>
                        <h3>Results</h3>
                        <div style="clear: both"></div>
                        <div id="tables" style="overflow-x: auto"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="facebox" style="display: none">
        <div class="popup">
            <div class="shortcuts">
                <h2>Keyboard shortcuts</h2>
                <div>
                    <dl>
                        <dt>F5</dt>
                        <dd>Execute highlighted query</dd>
                    </dl>
                    <dl>
                        <dt>CTRL-1</dt>
                        <dd>List tables</dd>
                    </dl>
                    <dl>
                        <dt>CTRL-2</dt>
                        <dd>List views</dd>
                    </dl>
                    <dl>
                        <dt>CTRL-3</dt>
                        <dd>List procedures</dd>
                    </dl>
                    <dl>
                        <dt>CTRL-4</dt>
                        <dd>List functions</dd>
                    </dl>
                    <dl>
                        <dt>CTRL-5</dt>
                        <dd><span class="code">EXEC sp_helptext '<em>highlighted text</em>'</span> -- Shows object's SQL definition.</dd>
                    </dl>
                    <dl>
                        <dt>CTRL-6</dt>
                        <dd><span class="code">EXEC sp_columns '<em>highlighted text</em>'</span> -- Shows table/view's columns.</dd>
                    </dl>
                    <dl>
                        <dt>CTRL-0</dt>
                        <dd><span class="code">SELECT * FROM <em>highlighted text</em></span></dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>
    <div id="facebox_overlay" style="display: none"></div>
<script type="text/javascript">
'use strict';

document.onreadystatechange = function () {
    if (document.readyState == "complete")
        initApp();
};

String.prototype.endsWith = function (e) {
    return this.substring(this.length - e.length, this.length) == e;
}

Array.prototype.contains = function (item) {
    for (var i = 0; i < this.length; ++i)
        if (this[i] === item) return true;
    return false;
}

var defaultDsList = ['(local)'];

var getDsList = !supports_html5_storage() ? function () { return defaultDsList; } : function () {
    try {
        var list = localStorage.getItem('sqlui.dsList');
        if (!list) return defaultDsList;
        return JSON.parse(list);
    } catch (e) {
        return defaultDsList;
    }
}

var setDsList = !supports_html5_storage() ? function () { } : function (dsList) {
    localStorage.setItem('sqlui.dsList', JSON.stringify(dsList));
}

var queryXhr = null;

function initApp() {
    getDeviceWidth();
    getDeviceHeight();

    // Load and populate the dataSources <datalist>:
    var dsList = getDsList();
    loadDataSources(dsList);

    // Parse the query string and pre-populate fields:
    prepopulate();

    // Window resize:
    bindEvent(window, 'resize', function (e) { resizeResults(); });

    // Query resize bar:
    var dgQuery = new drag();
    dgQuery.init({ id: "rszQuery", target: "query", direction: "y", limit: { y: [100, 1080] }, callback: resizeResults });

    // Click help button to show facebox:
    bindEvent(find('btnHelp'), 'click', function (e) {
        if (find('facebox').style.display !== 'none') {
            hide('facebox');
            hide('facebox_overlay');
        } else {
            show('facebox_overlay');
            setStyle(find('facebox'), 'left', '' + ((getDeviceWidth() / 2) - (640 / 2)).toString() + 'px');
            show('facebox');
        }
    });

    // Click outside facebox to hide:
    bindEvent(find('facebox_overlay'), 'click', function (e) {
        hide('facebox');
        hide('facebox_overlay');
    });

    // Change head repeat checkbox:
    bindEvent(find('chkHeadRepeat'), 'change', function (e) {
        if (v('chkHeadRepeat')) {
            find('numHeadRepeat').disabled = false;
        } else {
            find('numHeadRepeat').disabled = true;
        }
    });

    // Update UI on "Integrated Security" checkbox change:
    bindEvent(find('intsec'), 'change', function (e) {
        var intsec = v('intsec');
        find('uid').disabled = intsec;
        find('pwd').disabled = intsec;
    });

    // Cancel:
    bindEvent(find('btnCancel'), 'click', function (e) {
        if (queryXhr === null) return;
        queryXhr.abort();

        queryXhr = null;
        find('btnExecute').disabled = false;
        find('btnCancel').disabled = true;
    });

    // Update link:
    bindEvent(find('btnLink'), 'click', function (e) {
        var url = window.location.pathname + '?' + genQueryString();
        var selflink = find('selflink');
        selflink.setAttribute('href', url);
        show('selflink');
    });

    // whole-page keyboard shorcuts:
    bindEvent(document.body, 'keydown', function (e) {
        if (!e.ctrlKey) {
            if (e.keyCode === 116) {
                // e.keyIdentifier == "F5"
                // F5 - execute query
                e.preventDefault();
                executeHighlightedQuery();
                return true;
            }
            return false;
        }

        // Pick text out from the user's selection in the browser (e.g. for selecting data from query results)
        var highlighted = getBrowserSelectedText();

        var query = null;

        if (e.keyCode === '1'.charCodeAt(0)) {
            // CTRL-1: List tables
            query = 'SELECT [name] AS table_name,create_date,modify_date FROM sys.tables ORDER BY [name] ASC';
        } else if (e.keyCode === '2'.charCodeAt(0)) {
            // CTRL-2: List views
            query = 'SELECT [name] AS view_name,create_date,modify_date FROM sys.views ORDER BY [name] ASC';
        } else if (e.keyCode === '3'.charCodeAt(0)) {
            // CTRL-3: List procedures
            query = 'SELECT [name] AS sproc_name,create_date,modify_date FROM sys.procedures ORDER BY [name] ASC';
        } else if (e.keyCode === '4'.charCodeAt(0)) {
            // CTRL-4: List functions
            query = 'SELECT [name] AS function_name,create_date,modify_date FROM sys.objects WHERE [type] IN (\'FN\',\'TF\',\'IF\') ORDER BY [name] ASC';
        } else if (e.keyCode === '5'.charCodeAt(0)) {
            // CTRL-5: sp_helptext;
            if (!highlighted) {
                // A highlighted word is required.
                e.preventDefault();
                return true;
            }
            query = 'EXEC sp_helptext \'' + highlighted.replace('\'', '\'\'') + '\'';
        } else if (e.keyCode === '6'.charCodeAt(0)) {
            // CTRL-6: sp_columns;
            if (!highlighted) {
                // A highlighted word is required.
                e.preventDefault();
                return true;
            }
            query = 'EXEC sp_columns \'' + highlighted.replace('\'', '\'\'') + '\'';
        } else {
            return false;
        }

        // Stop the browser from responding to the keystroke:
        e.preventDefault();

        queryXhr = runQuery({
            query: query,
            rowcount: 0,
            before: showQueryResultsBefore,
            after: showQueryResultsAfter,
            error: showQueryResultsError,
            success: showQueryResults
        });

        return true;
    });

    // textarea keyboard shortcuts:
    bindEvent(find('query'), 'keydown', function (e) {
        if (!e.ctrlKey) {
            return false;
        }

        var highlighted = getSelectedQueryText();
        var query = null;
        var rowcount = 0;   // unlimited

        if (e.keyCode === '0'.charCodeAt(0)) {
            // CTRL-0: `SELECT * FROM [...]`
            query = 'SELECT * FROM ' + highlighted;
            rowcount = v('rowcount');
        } else if (e.keyCode === '5'.charCodeAt(0)) {
            // CTRL-5: sp_helptext;
            query = 'EXEC sp_helptext \'' + highlighted.replace('\'', '\'\'') + '\'';
        } else if (e.keyCode === '6'.charCodeAt(0)) {
            // CTRL-6: sp_columns;
            query = 'EXEC sp_columns \'' + highlighted.replace('\'', '\'\'') + '\'';
        }

        if (query === null) return false;

        // Stop the browser from responding to the keystroke:
        e.preventDefault();

        queryXhr = runQuery({
            query: query,
            rowcount: rowcount,
            before: showQueryResultsBefore,
            after: showQueryResultsAfter,
            error: showQueryResultsError,
            success: showQueryResults
        });

        return true;
    });

    // Connect:
    bindEvent(find('btnConnect'), 'click', function (e) {
        var auid = find('auid');
        var apwd = find('apwd');
        auid.classList.remove('highlight');
        apwd.classList.remove('highlight');
        hide('divErrors');
        resizeResults();

        runQuery({
            query:   'SELECT [name],[database_id] FROM sys.databases ORDER BY [name] ASC',
            ic:      'master',
            before:  function () { find('btnConnect').disabled = true; },
            after:   function () { find('btnConnect').disabled = false; },
            error:   showQueryResultsError,
            success: function (rsp) {
                // Add to the dsList:
                try {
                    var ds = v('ds');
                    var dsList = getDsList();
                    if (dsList && !dsList.contains(ds)) {
                        dsList.push(v('ds'));
                        setDsList(dsList);
                        // Refresh the <datalist>:
                        loadDataSources(dsList);
                    }
                } catch (e) {
                    // don't care.
                }

                // Fill the catalogs <datalist>:
                var dbs = find('catalogs');
                clearAllChildren(dbs);

                var rows = rsp.results[0].rows;
                for (var i = 0; i < rows.length; ++i) {
                    var opt = make('option');
                    var dbname = rows[i][0];             // [name]
                    setTextContent(opt, dbname);
                    dbs.appendChild(opt);
                }
            }
        });

        e.preventDefault();
        return false;
    });

    // Execute:
    bindEvent(find('btnExecute'), 'click', function (e) {
        executeHighlightedQuery();
        e.preventDefault();
        return false;
    });
}

function loadDataSources(dsList) {
    // Fill the <datalist> element:
    var ds = find('dataSources');
    clearAllChildren(ds);
    for (var i = 0; i < dsList.length; ++i) {
        var opt = make('option');
        setTextContent(opt, dsList[i]);
        ds.appendChild(opt);
    }
}

function tryParseInt(i) {
    try {
        return parseInt(i);
    } catch (e) {
        return null;
    }
}

function genQueryString() {
    var s =
        'ds=' + encodeURIComponent(v('ds')) +
        '&ic=' + encodeURIComponent(v('ic')) +
        '&timeout=' + encodeURIComponent(v('timeout')) +
        '&rowcount=' + encodeURIComponent(v('rowcount')) +
        '&rownumbers=' + encodeURIComponent(v('chkRowNumbers') ? '1' : '0') +
        '&headrepeat=' + encodeURIComponent(v('chkHeadRepeat') ? v('numHeadRepeat') : '0') +
        (v('intsec') ? '' : (
            '&uid=' + encodeURIComponent(v('uid')) +
            '&pwd=' + encodeURIComponent(v('pwd'))
        )) +
        '&q=' + encodeURIComponent(v('query'));
    return s;
}

function prepopulate() {
    var ds = getParameterByName('ds');
    var ic = getParameterByName('ic');
    var q = getParameterByName('q');
    var uid = getParameterByName('uid');
    var pwd = getParameterByName('pwd');
    var timeout = getParameterByName('timeout');
    var rowcount = getParameterByName('rowcount');
    var rownumbers = getParameterByName('rownumbers');
    var headrepeat = getParameterByName('headrepeat');

    if (ds !== null) v('ds', ds);
    if (ic !== null) v('ic', ic);
    if (q !== null) v('query', q);
    if (uid !== null) {
        v('uid', uid);
        if (pwd !== null) v('pwd', pwd);

        v('intsec', false);
        find('uid').disabled = false;
        find('pwd').disabled = false;
    }
    if (timeout !== null) v('timeout', timeout);
    if (rowcount !== null) v('rowcount', rowcount);

    if (headrepeat !== null) {
        var rpt = tryParseInt(headrepeat);
        if (rpt !== null) {
            if (rpt !== 0) {
                v('chkHeadRepeat', true);
                v('numHeadRepeat', rpt);
            } else {
                v('chkHeadRepeat', false);
            }
        }
    }
    if (rownumbers !== null) {
        var num = tryParseInt(rownumbers);
        v('chkRowNumbers', (!!num && num !== 0));
    }
}

function executeHighlightedQuery() {
    if (queryXhr !== null) {
        alert('A query is already executing. Please wait or cancel it.');
        find('btnCancel').disabled = false;
        return;
    }

    // Get selected query text:
    var query = getSelectedQueryText();

    // Execute query asynchronously:
    queryXhr = runQuery({
        query: query,
        rowcount: v('rowcount'),
        before: showQueryResultsBefore,
        after: showQueryResultsAfter,
        error: showQueryResultsError,
        success: showQueryResults
    });
}

function showQueryResultsError(rsp) {
    var ul = find('ulErrors');
    clearAllChildren(ul);
    if (rsp.errors) {
        // multiple errors:
        for (var i = 0; i < rsp.errors.length; ++i) {
            // TODO: make clickable to select line in textarea!
            setTextContent(ul.appendChild(make('li')), rsp.errors[i].message);
        }
    } else {
        // single error:
        setTextContent(ul.appendChild(make('li')), rsp.error);

        if (rsp.error === 'Unauthorized') {
            // highlight the auid/apwd controls:
            var auid = find('auid');
            var apwd = find('apwd');
            auid.classList.add('highlight');
            apwd.classList.add('highlight');
            auid.focus();
        }
    }

    show('divErrors');
    resizeResults();
}

function showQueryResultsBefore() {
    var auid = find('auid');
    var apwd = find('apwd');
    auid.classList.remove('highlight');
    apwd.classList.remove('highlight');
    hide('tables');
    hide('divErrors');
    hide('txtMsec');
    find('btnExecute').disabled = true;
    find('btnCancel').disabled = false;
}

function showQueryResultsAfter() {
    queryXhr = null;
    find('btnExecute').disabled = false;
    find('btnCancel').disabled = true;
    resizeResults();
}

function parseColumnInfo(raw) {
    var ci = { name: '', type: '', basetype: '', isNullable: true };
    var endsq = raw.indexOf(']');
    ci.name = raw.substring(1, endsq);
    ci.type = raw.substring(endsq + 2, raw.length);
    if (ci.type.endsWith(' NOT NULL')) {
        ci.isNullable = false;
        ci.type = ci.type.substring(0, ci.type.length - ' NOT NULL'.length);
    }
    ci.basetype = ci.type;
    var lpidx = ci.basetype.indexOf('(');
    if (lpidx >= 0) {
        ci.basetype = ci.basetype.substring(0, lpidx);
    }
    return ci;
}

function showQueryResults(rsp) {
    var tables = find('tables');
    clearAllChildren(tables);

    var repeatHead = v('chkHeadRepeat');
    var repeatHeadEvery = v('numHeadRepeat');
    var showRowNumber = v('chkRowNumbers');

    // Display timing:
    if (rsp.timing) {
        setTextContent(find('txtMsec'), rsp.timing.total + ' ms');
    }

    // Enumerate all results and create tables for them:
    for (var n = 0; n < rsp.results.length; ++n) {
        var resultset = rsp.results[n];
        tables.appendChild(text(resultset.rows.length + ' row(s)'));
        if (resultset.rows.length == 0) {
            continue;
        }

        // Parse the column info:
        var colInfos = new Array(resultset.columns.length);
        for (var i = 0; i < resultset.columns.length; ++i)
            colInfos[i] = parseColumnInfo(resultset.columns[i]);

        // Make the table:
        var tbl = make('table');
        tbl.classList.add('tblResults');
        tbl.setAttribute('border', '1');
        setStyle(tbl, 'width', find('query').clientWidth + ' px');

        var tbody = tbl.appendChild(make('tbody'));

        for (var r = 0; r < resultset.rows.length; ++r) {
            // Make a head row every N rows or just once:
            if ((repeatHead && (r % repeatHeadEvery == 0)) || (r == 0)) {
                var headrow = tbody.appendChild(make('tr'));

                if (showRowNumber) {
                    var thnum = headrow.appendChild(make('th'));
                    setTextContent(thnum, '#');
                    setStyle(thnum, 'text-align', 'right');
                }

                for (var i = 0; i < resultset.columns.length; ++i) {
                    var th = headrow.appendChild(make('th'));
                    var ci = colInfos[i];
                    th.setAttribute('data-basetype', ci.basetype);
                    th.setAttribute('data-type', ci.type);
                    th.setAttribute('title', ci.type + (ci.isNullable ? '' : ' NOT NULL'));
                    setTextContent(th, ci.name);
                }
            }

            // Make a data row:
            var tr = tbody.appendChild(make('tr'));
            var row = resultset.rows[r];

            if (showRowNumber) {
                var tdrownum = tr.appendChild(make('td'));
                setTextContent(tdrownum, (r + 1));
                tdrownum.classList.add('rownum');
            }

            for (var c = 0; c < row.length; ++c) {
                var td = tr.appendChild(make('td'));

                var val = row[c];
                var disp = val;

                // Treat NULLs specially:
                if (val === null) {
                    td.classList.add('nullv');
                    setTextContent(td, 'NULL');
                    continue;
                }

                // TODO(jsd): Support more formatting cases based on types
                var bt = colInfos[c].basetype;

                // Booleans:
                if (bt == 'bit') {
                    disp = val ? '1' : '0';
                    setStyle(td, 'text-align', 'center');
                }

                // Right-align numerics:
                if (bt == 'int' || bt == 'smallint' || bt == 'tinyint') {
                    setStyle(td, 'text-align', 'right');
                }

                // Pre-formatted text columns:
                if (bt == 'varchar' || bt == 'nvarchar' || bt == 'char' || bt == 'nchar' || bt == 'text' || bt == 'ntext' || bt == 'datetime') {
                    var pre = td.appendChild(make('pre'));
                    setTextContent(pre, disp);
                } else {
                    // Regular left-aligned text:
                    setTextContent(td, disp);
                }
            }
        } // for (var r)

        // Add the generated table to the DOM:
        tables.appendChild(tbl);
    }

    show('tables');
    show('txtMsec');
    // Move input focus to query textarea:
    find('query').focus();
}

function getSelectedQueryText() {
    // Get selected query text:
    var qtextarea = find('query');
    var selstart = qtextarea.selectionStart;
    var selend = qtextarea.selectionEnd;
    var query = qtextarea.value;
    if (selend > selstart) {
        query = query.substring(selstart, selend);
    }
    return query;
}

function resizeResults() {
    var tables = find('tables');
    var newWidth = getDeviceWidth() - 8 - 32;
    var newHeight = getDeviceHeight() - 24 - (find('trResults').offsetHeight - tables.offsetHeight) - find('commandBar').offsetHeight - find('toppanel').offsetHeight - find('trQuery').offsetHeight;
    setStyle(tables, 'width', '' + newWidth + 'px');
    setStyle(tables, 'height', '' + newHeight + 'px');
}

function runQuery(opts) {
    var auid = v('auid');
    var apwd = v('apwd');

    var ds = opts.ds || v('ds');
    find('ds').classList.remove('highlight');
    if (ds === null || ds.length == 0) {
        find('ds').classList.add('highlight');
        return null;
    }

    var ic = opts.ic || v('ic') || 'master';
    var intsec = v('intsec');
    var uid = v('uid');
    var pwd = v('pwd');

    var rowcount = opts.rowcount || 0;
    var tmout = opts.timeout || v('timeout') || 30;

    var query = opts.query;
    var error = opts.error;
    var success = opts.success;
    var before = opts.before || function () { };
    var after = opts.after || function () { };

    var url = 'sql.ashx?ds=' + encodeURIComponent(ds) +
        '&ic=' + encodeURIComponent(ic) +
        (intsec ? '' : ('&uid=' + encodeURIComponent(uid) + '&pwd=' + encodeURIComponent(pwd))) +
        '&tmout=' + encodeURIComponent(tmout) +
        '&rowcount=' + encodeURIComponent(rowcount);

    var xhr = new XMLHttpRequest();
    xhr.open('POST', url, true);
    xhr.setRequestHeader('Authorization', 'Basic ' + Base64.encode(auid + ':' + apwd));
    xhr.onreadystatechange = function () {
        if (this.readyState != 4) return;
        try {
            var rsp = JSON.parse(this.responseText);
            if (this.status != 200) {
                error(rsp);
            } else {
                success(rsp);
            }
        } catch (ex) { }
        after();
    };
    before();
    xhr.send(query);
    return xhr;
}

function find(id) { return document.getElementById(id); }
function make(tag) { return document.createElement(tag); }
function text(text) { return document.createTextNode(text); }
function setStyle(el, prop, value) {
    if (el.style.setProperty !== undefined)
        el.style.setProperty(prop, value);
    else
        el.style.setAttribute(prop, value);
}

// Alternatively, try `visibility` style.
function hide(id) { setStyle(find(id), 'display', 'none'); }
function show(id) {
    var obj = find(id);

    var disp = 'block';
    if (obj.tagName) {
        if (obj.tagName === 'A')
            disp = 'inline';
        else if (obj.tagName === 'TD')
            disp = 'table-cell';
    }

    setStyle(obj, 'display', disp);
}
function toggle(id) {
    var obj = find(id);
    if (obj.style.display === 'none') {
        show(id);
        return true;
    } else {
        hide(id);
        return false;
    }
}

function v(id, setValue) {
    var el = find(id);
    if (el === null) return null;

    if (el.getAttribute('type') === 'number') {
        // NOTE(jsd): The try/catch is for FF failure.
        try {
            if (setValue !== undefined)
                el.valueAsNumber = setValue;
            if (isNaN(el.valueAsNumber))
                return el.value;
            return el.valueAsNumber;
        } catch (e) {
            // default to using `value`:
            if (setValue !== undefined)
                el.value = setValue;
            return el.value;
        }
    }

    // Support for checkboxes with true/false values for checked/unchecked:
    if (el.getAttribute('type') === 'checkbox') {
        if (setValue !== undefined) {
            if (!!setValue)
                el.setAttribute('checked', 'checked');
            else
                el.removeAttribute('checked');
        }
        return el.checked;
    }

    if (setValue !== undefined)
        el.value = setValue;
    return el.value;
}

function clearAllChildren(el) {
    while (el.firstChild)
        el.removeChild(el.firstChild);
}

function setTextContent(el, text) {
    clearAllChildren(el);
    el.appendChild(document.createTextNode(text));
}

function getParameterByName(name) {
    name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
    var regexS = "[\\?&]" + name + "=([^&#]*)";
    var regex = new RegExp(regexS);
    var results = regex.exec(window.location.search);
    if (results == null)
        return null;
    else
        return decodeURIComponent(results[1].replace(/\+/g, " "));
}

function bindEvent(target, type, listener) {
    if (target.addEventListener !== undefined)
        target.addEventListener(type, listener, false);
    else
        target.attachEvent('on' + type, listener);
}

function supports_html5_storage() {
    try {
        return 'localStorage' in window && window['localStorage'] !== null;
    } catch (e) {
        return false;
    }
}

function getDeviceWidth() {
    var w = null;
    return (function () {
        if (w === null)
            w = window.innerWidth;
        return w;
    })();
}

function getDeviceHeight() {
    var h = null;
    return (function () {
        if (h === null)
            h = window.innerHeight;
        return h;
    })();
}

function getBrowserSelectedText() {
    try {
        // Works for Chrome. Might need more hacks for non-Chrome.
        return window.getSelection().getRangeAt(0).toString();
    } catch (e) {
        return null;
    }
}

// Drag-to-resize support:

function addEvent(obj, type, fn) {
    if (obj.attachEvent) {
        obj["e" + type + fn] = fn;
        obj[type + fn] = function () { obj["e" + type + fn](window.event); }
        obj.attachEvent("on" + type, obj[type + fn]);
    } else
        obj.addEventListener(type, fn, false);
}

function removeEvent(obj, type, fn) {
    if (obj.detachEvent) {
        obj.detachEvent("on" + type, obj[type + fn]);
        obj[type + fn] = null;
    } else
        obj.removeEventListener(type, fn, false);
}

Function.prototype.bind = function (obj) {
    var _method = this;
    return function () {
        return _method.apply(obj, arguments);
    };
}

function drag(id) {
    this.id = "id";
    this.direction = "xy";
}

drag.prototype = {
    init: function (settings) {
        for (var i in settings) {
            this[i] = settings[i];

            for (var j in settings[i]) {
                //if (typeof(this[i][j])=="undefined")
                this[i][j] = settings[i][j];
            }
        }

        this.elem = (this.id.tagName === undefined) ? document.getElementById(this.id) : this.id;
        this.container = document.getElementById(settings.target) || this.elem.parentNode;
        this.elem.onmousedown = this._mouseDown.bind(this);
        this.callback = settings.callback || null;
    },
    _mouseDown: function (e) {
        e = e || window.event;

        this.elem.onselectstart = function () { return false };

        this._event_docMouseMove = this._docMouseMove.bind(this);
        this._event_docMouseUp = this._docMouseUp.bind(this);

        if (this.onstart) this.onstart();
        this.x = e.clientX || e.PageX;
        this.y = e.clientY || e.PageY;

        this.left = parseInt(getstyle(this.elem, "left"));
        this.top = parseInt(getstyle(this.elem, "top"));

        addEvent(document, 'mousemove', this._event_docMouseMove);
        addEvent(document, 'mouseup', this._event_docMouseUp);

        return false;
    },
    _docMouseMove: function (e) {
        this.setValuesClick(e);
        if (this.ondrag) this.ondrag();
    },
    _docMouseUp: function (e) {
        removeEvent(document, 'mousemove', this._event_docMouseMove);
        if (this.onstop) this.onstop();

        removeEvent(document, 'mouseup', this._event_docMouseUp);
    },
    setValuesClick: function (e) {
        this.mouseX = e.clientX || e.PageX;
        this.mouseY = e.clientY || e.pageY;

        this.Y = this.top + this.mouseY - this.y;
        this.Y = limit(this.Y, this.limit.y[0], this.limit.y[1]);
        this.elem.style.top = this.Y + "px";

        this.container.style.height = (this.Y - 3) + "px";
        if (this.callback) this.callback();
    }
}

function limit(val, mn, mx) {
    return Math.min(Math.max(val, Math.min(mn, mx)), Math.max(mn, mx));
}

function getstyle(elem, prop) {
    if (document.defaultView) {
        return document.defaultView.getComputedStyle(elem, null).getPropertyValue(prop);
    }
    else if (elem.currentStyle) {
        var prop = prop.replace(/-(\w)/gi, function ($0, $1) {
            //return $0.charAt($0.length - 1).toUpperCase();
            return $1.toUpperCase();
        });
        return elem.currentStyle[prop];
    }
    else return null;
}

var Base64 = {
    // private property
    _keyStr: "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",

    // public method for encoding
    encode: function (input) {
        var output = "";
        var chr1, chr2, chr3, enc1, enc2, enc3, enc4;
        var i = 0;

        while (i < input.length) {
            chr1 = input.charCodeAt(i++);
            chr2 = input.charCodeAt(i++);
            chr3 = input.charCodeAt(i++);

            enc1 = chr1 >> 2;
            enc2 = ((chr1 & 3) << 4) | (chr2 >> 4);
            enc3 = ((chr2 & 15) << 2) | (chr3 >> 6);
            enc4 = chr3 & 63;

            if (isNaN(chr2)) {
                enc3 = enc4 = 64;
            } else if (isNaN(chr3)) {
                enc4 = 64;
            }

            output = output +
                this._keyStr.charAt(enc1) + this._keyStr.charAt(enc2) +
                this._keyStr.charAt(enc3) + this._keyStr.charAt(enc4);
        }

        return output;
    },
    // public method for decoding
    decode: function (input) {
        var output = "";
        var chr1, chr2, chr3;
        var enc1, enc2, enc3, enc4;
        var i = 0;

        input = input.replace(/[^A-Za-z0-9\+\/\=]/g, "");

        while (i < input.length) {
            enc1 = this._keyStr.indexOf(input.charAt(i++));
            enc2 = this._keyStr.indexOf(input.charAt(i++));
            enc3 = this._keyStr.indexOf(input.charAt(i++));
            enc4 = this._keyStr.indexOf(input.charAt(i++));

            chr1 = (enc1 << 2) | (enc2 >> 4);
            chr2 = ((enc2 & 15) << 4) | (enc3 >> 2);
            chr3 = ((enc3 & 3) << 6) | enc4;

            output = output + String.fromCharCode(chr1);

            if (enc3 != 64) {
                output = output + String.fromCharCode(chr2);
            }
            if (enc4 != 64) {
                output = output + String.fromCharCode(chr3);
            }
        }

        return output;
    }
};
</script>
</body>
</html>
