<!DOCTYPE html>

<html>
<head>
    <title>SQL Query</title>
    <style type="text/css">
body, p, div, span, table, input, button, textarea, a, ol, h1, h2, h3, h4, h5, h6 {
    border-spacing: 0px 0px;
    padding: 0;
    margin: 0;
    color: #999999;
}
body {
    font-family: Segoe UI, Verdana, Tahoma;
    font-size: small;
    margin-top: 4px !important;
    margin-left: 4px !important;
    margin-right: 12px !important;
    margin-bottom: 12px !important;
    height: 100%;
    overflow: hidden;
    background-color: #151515 !important;
}
ul, ol, li {
    border-spacing: 0px 0px;
    margin: 0;
}
ul, ol {
    padding-left: 24px;
}
button {
    padding: 2px 4px 2px 4px;
    border-radius: 3px 3px;
    border-style: double;
    border-color: #1a1a1a;
    background-color: #1f1f1f;
    text-shadow: black 0.1em 0.1em 0.2em;
    cursor: pointer;
}
button:disabled {
    border-color: #2a2a2a;
    background-color: #303030;
    color: #aaa;
    text-shadow: #666 -0.1em -0.1em -0.2em;
    cursor: default;
}
table td, table th {
    padding: 0;
    margin: 0;
    text-align: left;
    vertical-align: top;
}
input {
    border: 1px solid gray;
    background-color: #101010;
    color: #bbb;
}
textarea {
    font-family: 'Anonymous Pro', Consolas, 'Courier New', 'Lucida Console', monospace;
    background-color: #101010;
    color: #bbb;
}
input.sidebar {
    width: 240px;
}
input.sidebar-half {
    width: 110px;
}
.tblResults {
    border-spacing: 0px;
}
.tblResults > thead > tr > th {
    white-space: nowrap;
    background-color: #101010;
    color: #777;
}
.nowrap {
    white-space: nowrap;
}
td.rownum {
    font-weight: bold;
    text-align: right;
    background-color: #101010 !important;
    padding-right: 2px;
    padding-left: 2px;
}
td.sepright {
    border-right: 4px solid transparent;
}
td.septop {
    border-top: 4px solid transparent;
}
td.sepbottom {
    border-bottom: 4px solid transparent;
}
    </style>
</head>
<body>
    <table border="0" style="width: 100%"><tbody><tr>
        <td class="sepright">
            <table border="0">
                <tbody>
                    <tr>
                        <td class="nowrap">Auth:</td>
                        <td class="nowrap"><input id="auid" class="sidebar-half" type="text" value="username" />&nbsp;<input id="apwd" class="sidebar-half" type="password" value="password" /></td>
                    </tr>
                    <tr><td colspan="2">&nbsp;</td></tr>
                    <tr>
                        <td class="nowrap">Data Source:</td>
                        <td><input id="ds" class="sidebar" type="text" value="."/></td>
                    </tr>
                    <tr>
                        <td class="nowrap">Initial Catalog:</td>
                        <td><input id="ic" class="sidebar" type="text" value="master"/></td>
                    </tr>
                    <tr>
                        <td style="padding-top: 5px">&nbsp;</td>
                        <td style="padding-top: 5px"><input id="intsec" type="checkbox" checked="checked" />&nbsp;<label for="intsec">Integrated Security</label></td>
                    </tr>
                    <tr>
                        <td class="nowrap">User ID:</td>
                        <td><input id="uid" class="sidebar" type="text" value="" disabled="disabled" /></td>
                    </tr>
                    <tr>
                        <td class="nowrap">Password:</td>
                        <td><input id="pwd" class="sidebar" type="password" value="" disabled="disabled" /></td>
                    </tr>
                    <tr><td colspan="2">&nbsp;</td></tr>
                    <tr>
                        <td class="nowrap">Timeout:</td>
                        <td><input id="timeout" class="sidebar" type="text" value="30"/></td>
                    </tr>
                    <tr>
                        <td class="nowrap">Row Count:</td>
                        <td><input id="rowcount" class="sidebar" type="text" value="100"/></td>
                    </tr>
                    <tr>
                        <td colspan="2" class="septop">
                            <button id="btnConnect">Connect</button>
                            <div id="explorer" style="width: 100%; overflow-x: auto; overflow-y: auto">
                                <ul id="databases"></ul>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </td>
        <td style="width: 100%"><table border="0" style="width: 100%"><tbody>
            <tr id="trCmdBar">
                <td style="height: 28px">
                    <button type="button" id="btnExecute">Execute</button>&nbsp;
                    <button type="button" id="btnCancel" disabled="disabled">Cancel</button>&nbsp;
                    <button type="button" id="btnLink">Update Link</button>&nbsp;
                    <a id="selflink" href="#" style="display: none" title="Open query in new window" target="_blank">link</a>
                </td>
            </tr>
            <tr id="trQuery">
                <td style="height: 160px">
                    <textarea name="query" id="query" style="width: 100%; height: 100%; word-wrap: normal; overflow: auto" autofocus="autofocus" spellcheck="false">SELECT 1</textarea>
                </td>
            </tr>
            <tr id="trResults">
                <td style="min-height: 24px">
                    <div style="clear: both; overflow-y: auto">
                        <div id="divErrors" style="display: none; overflow-x: auto">
                            <h3>Errors</h3>
                            <ul id="ulErrors"></ul>
                        </div>
                        <div>
                            <h3>Results</h3>
                            <div id="tables" style="overflow-x: auto"></div>
                        </div>
                    </div>
                </td>
            </tr>
        </tbody></table></td>
    </tr></tbody></table>
<script type="text/javascript">
'use strict';

document.onreadystatechange = function () {
    if (document.readyState == "complete")
        initApp();
};

var queryXhr = null;

function bindEvent(target, type, listener) {
    if (target.addEventListener)
        target.addEventListener(type, listener, false);
    else
        target.attachEvent('on' + type, listener);
}

function showQueryResultsError(rsp) {
    var ul = find('ulErrors');
    clearAllChildren(ul);
    if (rsp.errors) {
        // multiple errors:
        for (var i = 0; i < rsp.errors.length; ++i) {
            // TODO: make clickable to select line in textarea!
            ul.appendChild(make('li')).innerText = rsp.errors[i].message;
        }
    } else {
        // single error:
        ul.appendChild(make('li')).innerText = rsp.error;
    }

    show('divErrors');
}

function showQueryResultsBefore() {
    hide('tables');
    hide('divErrors');
    find('btnExecute').disabled = true;
    find('btnCancel').disabled = false;
}

function showQueryResultsAfter() {
    queryXhr = null;
    find('btnExecute').disabled = false;
    find('btnCancel').disabled = true;
}

function showQueryResults(rsp) {
    var tables = find('tables');
    clearAllChildren(tables);

    // Enumerate all results and create tables for them:
    for (var n = 0; n < rsp.results.length; ++n) {
        var resultset = rsp.results[n];

        var tbl = tables.appendChild(make('table'));
        tbl.classList.add('tblResults');
        tbl.setAttribute('border', '1');
        setProp(tbl.style, 'width', find('query').clientWidth + ' px');

        var thead = tbl.appendChild(make('thead'));
        var tbody = tbl.appendChild(make('tbody'));

        // Make the head row:
        var headrow = thead.appendChild(make('tr'));
        var thnum = headrow.appendChild(make('th'));
        thnum.innerText = '#';
        setProp(thnum.style, 'textAlign', 'right');
        for (var i = 0; i < resultset.columns.length; ++i)
            headrow.appendChild(make('th')).innerText = resultset.columns[i];

        // Make the data rows:
        for (var r = 0; r < resultset.rows.length; ++r) {
            var tr = tbody.appendChild(make('tr'));
            var row = resultset.rows[r];
            var rownum = tr.appendChild(make('td'));
            rownum.innerText = '' + (r + 1);
            rownum.classList.add('rownum');
            for (var c = 0; c < row.length; ++c) {
                var td = tr.appendChild(make('td'));
                td.innerText = '' + row[c];
            }
        }
    }

    resizeResults();
    show('tables');
}

function prepopulate() {
    var ds = getParameterByName('ds');
    var ic = getParameterByName('ic');
    var q = getParameterByName('q');
    var uid = getParameterByName('uid');
    var pwd = getParameterByName('pwd');
    var timeout = getParameterByName('timeout');
    var rowcount = getParameterByName('rowcount');

    if (ds !== null) v('ds', ds);
    if (ic !== null) v('ic', ic);
    if (q !== null) v('query', q);
    if (uid !== null) {
        v('uid', uid);
        if (pwd !== null) v('pwd', pwd);

        find('intsec').checked = false;
        find('uid').disabled = false;
        find('pwd').disabled = false;
    }
    if (timeout !== null) v('timeout', timeout);
    if (rowcount !== null) v('rowcount', rowcount);
}

function genQueryString() {
    var s = 'ds=' +
        encodeURIComponent(v('ds')) +
        '&ic=' + encodeURIComponent(v('ic')) +
        '&timeout=' + encodeURIComponent(v('timeout')) +
        '&rowcount=' + encodeURIComponent(v('rowcount')) +
        (find('intsec').checked ? '' : (
            '&uid=' + encodeURIComponent(v('uid')) +
            '&pwd=' + encodeURIComponent(v('pwd'))
        )) +
        '&q=' + encodeURIComponent(v('query'));
    return s;
}

function getSelectedQueryText() {
    // Get selected query text:
    var qtextarea = find('query');
    var selstart = qtextarea.selectionStart;
    var selend = qtextarea.selectionEnd;
    var query = qtextarea.value;
    if (selend > selstart) {
        query = query.substring(selstart, selend);
    }
    return query;
}

function resizeResults() {
    var tables = find('tables');
    setProp(tables.style, 'width', '' + find('query').clientWidth + 'px');
    var newHeight = window.innerHeight - (find('trResults').clientHeight - tables.clientHeight + 8) - find('trCmdBar').clientHeight - find('trQuery').clientHeight;
    setProp(tables.style, 'height', '' + newHeight + 'px');
}

function initApp() {
    // Parse the query string and pre-populate fields:
    prepopulate();

    // Window resize:
    bindEvent(window, 'resize', function (e) {
        resizeResults();
    });

    // Update UI on "Integrated Security" checkbox change:
    bindEvent(find('intsec'), 'change', function (e) {
        var intsec = find('intsec').checked;
        find('uid').disabled = intsec;
        find('pwd').disabled = intsec;
    });

    // Cancel:
    bindEvent(find('btnCancel'), 'click', function (e) {
        if (queryXhr === null) return;
        queryXhr.abort();
    });

    // Update link:
    bindEvent(find('btnLink'), 'click', function (e) {
        var url = window.location.pathname + '?' + genQueryString();
        var selflink = find('selflink');
        selflink.setAttribute('href', url);
        show('selflink');
    });

    // textarea keyboard shortcuts:
    bindEvent(find('query'), 'keyup', function (e) {
        if (!e.ctrlKey) return false;

        var highlighted = getSelectedQueryText();
        var query = null;
        var rowcount = 0;

        if (e.keyCode == '5'.charCodeAt(0)) {
            // CTRL-5: sp_helptext;
            query = 'exec sp_helptext \'' + highlighted.replace('\'', '\'\'') + '\'';
        } else if (e.keyCode == '0'.charCodeAt(0)) {
            // CTRL-0: SELECT * FROM;
            query = 'SELECT * FROM ' + highlighted;
            rowcount = v('rowcount');
        }

        if (query === null) return false;

        queryXhr = runQuery({
            query: query,
            rowcount: rowcount,
            before: showQueryResultsBefore,
            after: showQueryResultsAfter,
            error: showQueryResultsError,
            success: showQueryResults
        });
        return true;
    });

    // Connect:
    bindEvent(find('btnConnect'), 'click', function (e) {
        hide('databases');
        runQuery({
            query: "SELECT [name],[database_id] FROM sys.databases ORDER BY [name] ASC",
            error: showQueryResultsError,
            success: function (rsp) {
                var rows = rsp.results[0].rows;
                var dbs = find('databases');
                clearAllChildren(dbs);
                for (var i = 0; i < rows.length; ++i) {
                    var li = make('li');
                    li.innerText = rows[i][0];                  // [name]
                    li.setAttribute('data-id', rows[i][1]);     // [database_id]
                    dbs.appendChild(li);
                }
                show('databases');
            }
        });
        return false;
    });

    // Execute:
    bindEvent(find('btnExecute'), 'click', function (e) {
        if (queryXhr !== null) {
            alert('A query is already executing. Please wait or cancel it.');
            find('btnCancel').disabled = false;
            return;
        }

        // Get selected query text:
        var query = getSelectedQueryText();

        // Execute query asynchronously:
        queryXhr = runQuery({
            query: query,
            rowcount: v('rowcount'),
            before: showQueryResultsBefore,
            after: showQueryResultsAfter,
            error: showQueryResultsError,
            success: showQueryResults
        });

        return false;
    });
}

function runQuery(opts) {
    var auid = v('auid');
    var apwd = v('apwd');

    var ds = v('ds');
    var ic = v('ic');
    var intsec = find('intsec').checked;
    var uid = v('uid');
    var pwd = v('pwd');

    var rowcount = opts.rowcount || 0;
    var tmout = opts.timeout || v('timeout') || 30;

    var query = opts.query;
    var error = opts.error;
    var success = opts.success;
    var before = opts.before || function () { };
    var after = opts.after || function () { };

    var url = 'sql.ashx?ds=' + encodeURIComponent(ds) +
        '&ic=' + encodeURIComponent(ic) +
        (intsec ? '' : ('&uid=' + encodeURIComponent(uid) + '&pwd=' + encodeURIComponent(pwd))) +
        '&tmout=' + encodeURIComponent(tmout) +
        '&rowcount=' + encodeURIComponent(rowcount);

    var xhr = new XMLHttpRequest();
    xhr.open('POST', url, true);
    xhr.setRequestHeader('Authorization', 'Basic ' + Base64.encode(auid + ':' + apwd));
    xhr.onreadystatechange = function () {
        if (this.readyState != 4) return;
        try {
            var rsp = JSON.parse(this.responseText);
            if (this.status != 200) {
                error(rsp);
            } else {
                success(rsp);
            }
        } catch (ex) { }
        after();
    };
    before();
    xhr.send(query);
    return xhr;
}

function find(id) { return document.getElementById(id); }
function make(tag) { return document.createElement(tag); }
function setProp(style, prop, value) {
    if (style.setProperty)
        style.setProperty(prop, value);
    else
        style.setAttribute(prop, value);
}

function hide(id) { setProp(find(id).style, 'display', 'none'); }
function show(id) {
    var obj = find(id);
    if (obj.tagName && obj.tagName === 'A')
        setProp(obj.style, 'display', 'inline');
    else
        setProp(obj.style, 'display', 'block');
}

function v(id, setValue) {
    var el = find(id);
    if (el === null) return null;
    if (setValue !== undefined)
        el.value = setValue;
    return el.value;
}

function clearAllChildren(el) {
    while (el.firstChild) {
        el.removeChild(el.firstChild);
    }
}

function getParameterByName(name) {
    name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
    var regexS = "[\\?&]" + name + "=([^&#]*)";
    var regex = new RegExp(regexS);
    var results = regex.exec(window.location.search);
    if (results == null)
        return null;
    else
        return decodeURIComponent(results[1].replace(/\+/g, " "));
}

var Base64 = {
    // private property
    _keyStr: "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",

    // public method for encoding
    encode: function (input) {
        var output = "";
        var chr1, chr2, chr3, enc1, enc2, enc3, enc4;
        var i = 0;

        while (i < input.length) {
            chr1 = input.charCodeAt(i++);
            chr2 = input.charCodeAt(i++);
            chr3 = input.charCodeAt(i++);

            enc1 = chr1 >> 2;
            enc2 = ((chr1 & 3) << 4) | (chr2 >> 4);
            enc3 = ((chr2 & 15) << 2) | (chr3 >> 6);
            enc4 = chr3 & 63;

            if (isNaN(chr2)) {
                enc3 = enc4 = 64;
            } else if (isNaN(chr3)) {
                enc4 = 64;
            }

            output = output +
                this._keyStr.charAt(enc1) + this._keyStr.charAt(enc2) +
                this._keyStr.charAt(enc3) + this._keyStr.charAt(enc4);
        }

        return output;
    },
    // public method for decoding
    decode: function (input) {
        var output = "";
        var chr1, chr2, chr3;
        var enc1, enc2, enc3, enc4;
        var i = 0;

        input = input.replace(/[^A-Za-z0-9\+\/\=]/g, "");

        while (i < input.length) {
            enc1 = this._keyStr.indexOf(input.charAt(i++));
            enc2 = this._keyStr.indexOf(input.charAt(i++));
            enc3 = this._keyStr.indexOf(input.charAt(i++));
            enc4 = this._keyStr.indexOf(input.charAt(i++));

            chr1 = (enc1 << 2) | (enc2 >> 4);
            chr2 = ((enc2 & 15) << 4) | (enc3 >> 2);
            chr3 = ((enc3 & 3) << 6) | enc4;

            output = output + String.fromCharCode(chr1);

            if (enc3 != 64) {
                output = output + String.fromCharCode(chr2);
            }
            if (enc4 != 64) {
                output = output + String.fromCharCode(chr3);
            }
        }

        return output;
    }
};
</script>
</body>
</html>
